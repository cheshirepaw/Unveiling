"use strict";!function(){var e=new Map;function t(t,r,a){if(void 0===a&&r&&(a=r,r=null),State.length)throw new Error("addCharacter() -> must be called before story starts");t&&a?(e.has(t)&&console.error('addCharacter() -> overwriting character "'+t+'"'),e.set(t,{displayName:r,image:a})):console.error("addCharacter() -> invalid arguments")}function r(t,r,a,o){var n=$(document.createElement("div")).addClass(Util.slugify(r)+" say"),s=e.has(r)?e.get(r).image:null,i=$(document.createElement("img")).attr("src",o||s||"");i.attr("src")&&i.attr("src").trim()&&n.append(i);var u=r.toUpperFirst();return e.has(r)&&e.get(r).displayName&&(u=e.get(r).displayName),n.append($(document.createElement("p")).wiki(u)).append($(document.createElement("p")).wiki(a)),t&&(t instanceof $||(t=$(t)),n.appendTo(t)),n}setup.say=r,setup.addCharacter=t,Macro.add("character",{handler:function(){t(this.args[0],this.args[1],this.args[2])}}),$(document).one(":passagestart",(function(){var t=Array.from(e.keys());t.push("say"),Macro.add(t,{tags:null,handler:function(){"say"!==this.name?r(this.output,this.name,this.payload[0].contents):r(this.output,this.args[0],this.payload[0].contents,this.args[1])}})}))}(),function(){var e=e||{},t=[0,100];function r(e,t){var r,a=[],o=0,n=1;if("string"==typeof e)a=e.split("d");else if("number"==typeof e&&t)a=[e,t];else{if(!(Array.isArray(e)&&e.length>=2))throw new TypeError("dice(): could not process arguments...");e.length=2,a=e}if(a[0]=Number(a[0]),"string"==typeof a[1]&&"F"===a[1].trim().toUpperCase()?(a[1]=3,n=-1):a[1]=Number(a[1]),a.some((function(e){return Number.isNaN(e)})))throw new TypeError("dice(): could not process arguments...");for(r=0;r<a[0];r++)o+=Math.floor(State.random()*a[1])+n;return o}function a(e,t){if("string"==typeof e){var a=[(o=e.trim().replace(/\s/g,"").match(/(\d+[d][\df]\d*)(.*)/i))[1],Number(o[2])];return r(a[0])+a[1]}return r(e,t);var o}e.dice={roll:a},window.dice=window.dice||a,Number.prototype.dice||Object.defineProperty(Number.prototype,"dice",{configurable:!0,writable:!0,value:function(e){if(0===this)return 0;if(this<0)throw new TypeError("Number.prototype.dice: cannot roll a negative number of dice!");if(("string"!=typeof e||"F"!==e.trim().toUpperCase())&&(null==e||"number"!=typeof e||e<=0||!Number.isInteger(e)))throw new TypeError("Number.prototype.dice: error in argument");if(!Number.isInteger(this))throw new TypeError("Number.prototype.dice: cannot roll partial dice!");return a(this,e)}}),Number.prototype.fairmath||Object.defineProperty(Number.prototype,"fairmath",{configurable:!0,writable:!0,value:function(e){var r=t;if(this<r[0]||this>r[1])throw new TypeError("Number.prototype.fairmath called on a number that is out of the defined range (the number was "+this+").");if(null==e||"number"!=typeof e||e>100||e<-100||arguments.length<1)throw new TypeError("Number.prototype.fairmath given incorrect argument or an argument that is out of the valid 0-100 range.");if(0===e)return Math.clamp(Math.trunc(this),r[0],r[1]);if(e<0)return e*=-1,Math.clamp(Math.trunc(this-(this-r[0])*(e/r[1])),r[0],r[1]);if(e>0)return Math.clamp(Math.trunc(this+(r[1]-this)*(e/r[1])),r[0],r[1]);throw new Error("Number.prototype.fairmath encountered an unspecified error.")}}),Number.prototype.between||Object.defineProperty(Number.prototype,"between",{configurable:!0,writable:!0,value:function(e,t){if("number"!=typeof e||"number"!=typeof t)throw new TypeError("Number.between() -> both values must be numbers");var r=Number(this);if(e===t)return r===e;if(t<e){var a=t;t=e,e=a}return r>=e&&r<=t}}),Math.fairmath||Object.defineProperty(Math,"fairmath",{configurable:!0,writable:!0,value:function(e,t){return e.fairmath(t)}}),Math.between||Object.defineProperty(Math,"between",{configurable:!0,writable:!0,value:function(e,t,r){return e.between(t,r)}}),Math.fm||Object.defineProperty(Math,"fm",{configurable:!0,writable:!0,value:function(e,t){return e.fairmath(t)}}),Number.prototype.fm||Object.defineProperty(Number.prototype,"fm",{configurable:!0,writable:!0,value:function(e){return this.fairmath(e)}}),Number.prototype.d||Object.defineProperty(Number.prototype,"d",{configurable:!0,writable:!0,value:function(e){return this.dice(e)}})}(),Macro.add("mouseover",{tags:["onhover","onmouseover","onmousein","onmouseenter","onmouseout"],skipArgs:!0,handler:function(){if(this.payload.length<2)return this.error("No event tag used.");var e={mouseover:[],mousein:[],mouseout:[]},t=$(document.createElement("span")).addClass("macro-"+this.name).wiki(this.payload[0].contents).appendTo(this.output);this.payload.forEach((function(t){switch(t.name){case"onhover":case"onmouseover":e.mouseover.push(t.contents);break;case"onmousein":case"onmouseenter":e.mousein.push(t.contents);break;case"onmouseout":e.mouseout.push(t.contents);break;default:return}})),e.mouseover.length&&t.on("mouseover",this.createShadowWrapper((function(t){$.wiki(e.mouseover.join(" "))}))),e.mousein.length&&t.on("mouseenter",this.createShadowWrapper((function(t){$.wiki(e.mousein.join(" "))}))),e.mouseout.length&&t.on("mouseout",this.createShadowWrapper((function(t){$.wiki(e.mouseout.join(" "))})))}}),function(){function e(e,t){t=function(){return[].slice.call(arguments).flat(1/0).filter((function(e){return e&&"string"==typeof e&&e.trim()}))||[]}(t),$("#ui-overlay, #ui-dialog").addClass("popover"),$("#ui-overlay, #ui-dialog, #ui-dialog-body").addClass(t),t.includesAny("noclick","no-click")&&$("#ui-overlay").removeClass("ui-close"),Dialog.setup("","popover"),Dialog.wiki(e),Dialog.open(),$(document).one(":dialogclosed",(function(){$("#ui-overlay").addClass("ui-close"),$("#ui-overlay, #ui-dialog").removeClass("popover"),$("#ui-overlay, #ui-dialog, #ui-dialog-body").removeClass(t)}))}Macro.add("popover",{tags:null,handler:function(){e(this.payload[0].contents,this.args)}}),Macro.add("dismisspopover",{skipArgs:!0,handler:function(){$("ui-overlay").hasClass("popover")&&Dialog.close()}}),setup.popover=e}(),setup.messageMacro={},setup.messageMacro.default="Help",Macro.add("message",{tags:null,handler:function(){var e=this.payload[0].contents,t=$(document.createElement("span")),r=$(document.createElement(this.args.includes("btn")?"button":"a")),a=$(document.createElement("span"));r.wiki(this.args.length>0&&"btn"!==this.args[0]?this.args[0]:setup.messageMacro.default).ariaClick(this.createShadowWrapper((function(){t.hasClass("open")?a.css("display","none").empty():a.css("display","block").wiki(e),t.toggleClass("open")}))),t.attr("id","macro-"+this.name+"-"+this.args.join("").replace(/[^A-Za-z0-9]/g,"")).addClass("message-text").append(r).append(a).appendTo(this.output)}}),Macro.add("first",{skipArgs:!0,tags:["then","finally"],handler:function(){var e,t=$(document.createElement("span")),r=this.payload[this.payload.length-1],a=visited()-1;e=a<this.payload.length?this.payload[a].contents:"finally"===r.name?r.contents:"",t.wiki(e).addClass("macro-"+this.name).appendTo(this.output)}}),function(){var e={update:UIBar.setStoryElements,stow:UIBar.stow,unstow:UIBar.unstow,toggle:function(){$("#ui-bar").hasClass("stowed")?UIBar.unstow():UIBar.stow()},hide:function(){$("#ui-bar").css("display","none")},show:function(){$("#ui-bar").css("display","block")},kill:function(){$("#ui-bar").css("display","none"),$("#story").css("margin-left","2.5em")},restore:function(){$("#ui-bar").css("display","block"),$("#story").css("margin-left","20em")},jump:UI.jumpto,saves:UI.saves,restart:UI.restart,settings:UI.settings,share:UI.share,aliases:{refresh:"update",reload:"update",destroy:"kill",revive:"restore",jumpto:"jump",save:"saves",load:"saves",setting:"settings",sharing:"share"}},t=Object.keys(e);function r(r){return r&&"string"==typeof r?function(e){return t.includes(e)}(r=r.toLowerCase().trim())||(r=function(t){return e.aliases[t]||null}(r))?(e[r](),!1):'Command "'+r+'" is not a valid command.':"Command is not a string."}Macro.add("ui",{handler:function(){Array.isArray(this.args)&&this.args.length||this.error("No commands passed to macro.");var e,t=function(e){if(!Array.isArray(e))return"Command list error.";var t=[];return e.forEach((function(e){t.push(r(e))})),t}(this.args.flat(1/0));e=(t=t.filter((function(e){return"string"==typeof e}))).join(" "),t.length&&e&&this.error(e)}})}(),function(){var e=/\d+m?s$/;function t(e,t,r){"string"==typeof e&&("number"!=typeof t&&(t=!1),$(document).trigger({type:":notify",message:e,delay:t,class:r||""}))}$(document.body).append("<div id='notify'></div>"),$(document).on(":notify",(function(e){e.message&&"string"==typeof e.message&&(e.message.trim(),e.class?"string"==typeof e.class?e.class="open macro-notify "+e.class:Array.isArray(e.class)?e.class="open macro-notify "+e.class.join(" "):e.class="open macro-notify":e.class="open macro-notify",e.delay?("number"!=typeof e.delay&&(e.delay=Number(e.delay)),Number.isNaN(e.delay)&&(e.delay=2e3)):e.delay=2e3,$("#notify").empty().wiki(e.message).addClass(e.class),setTimeout((function(){$("#notify").removeClass()}),e.delay))})),Macro.add("notify",{tags:null,handler:function(){var r=this.payload[0].contents,a=!1,o=!1;if(this.args.length>0){var n=e.test(this.args[0]);"number"==typeof this.args[0]||n?(a=n?Util.fromCssTime(this.args[0]):this.args[0],o=this.args.length>1&&this.args.slice(1).flat(1/0)):o=this.args.flat(1/0).join(" ")}t(r,a,o)}}),setup.notify=t}();